default:
  image: ghcr.io/stefan-hoeck/idris2-pack:latest

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  PACK_DIR: $CI_PROJECT_DIR/.pack

prepare-pack:
  stage: .pre
  script:
    - pack update-db
    - pack switch "$( if [[ "$CI_PIPELINE_SOURCE" == 'schedule' ]]; then echo latest; else cat .pack-collection; fi )"
    - pack install contrib test
  artifacts:
    paths:
      - $PATH_DIR
    exclude:
      - $PATH_DIR/.cache/**/*

.uses-prepared-pack:
  before_script:
    - export PATH="$PACK_DIR/bin:$PATH"

.idris-build-job:
  artifacts:
    paths:
      - "**/build/**/*.tt[cm]"
    expire_in: 3 hrs

stages:
  - thirdparties:build
  - lint
  - deptycheck:build
  - deptycheck:docs
  - deptycheck:install
  - deptycheck:test:lib
  - deptycheck:test:docs
  - deptycheck:test:derive
  - pil:build
  - pil:test

thirdparties:build:
  extends:
    - .uses-prepared-pack
    - .idris-build-job
  stage: thirdparties:build
  needs:
    - prepare-pack
  script:
    - make thirdparties

deptycheck:build:
  extends:
    - .uses-prepared-pack
    - .idris-build-job
  stage: deptycheck:build
  needs:
    - prepare-pack
    - thirdparties:build
  script:
    - make deptycheck

deptycheck:docs:
  stage: deptycheck:docs
  image: ${CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX}/sphinxdoc/sphinx:latest
  needs: []
  script:
    - pip3 install -r docs/requirements.txt
    - make docs

deptycheck:install:after_build:
  extends: .uses-prepared-pack
  stage: deptycheck:install
  needs:
    - prepare-pack
    - deptycheck:build
  script:
    - make install
    - make test-installation

deptycheck:install:clean:
  extends: .uses-prepared-pack
  stage: deptycheck:install
  needs:
    - prepare-pack
  script:
    - make install
    - make test-installation

deptycheck:test:lib:
  extends: .uses-prepared-pack
  stage: deptycheck:test:lib
  needs:
    - prepare-pack
    - deptycheck:build
  script:
    - make test-deptycheck only=lib/ INTERACTIVE="--color"

deptycheck:test:docs:
  extends: .uses-prepared-pack
  stage: deptycheck:test:docs
  needs:
    - prepare-pack
    - deptycheck:build
  script:
    - make test-deptycheck only=docs/ INTERACTIVE="--color"

deptycheck:test:derive:
  extends: .uses-prepared-pack
  stage: deptycheck:test:derive
  needs:
    - prepare-pack
    - deptycheck:build
    - deptycheck:test:lib
  only:
    changes:
      - "*"
      - src/**/*
      - tests/*
      - tests/gen-derivation/**/*
      - thirdparty/**/*
      - depends/**/*
  parallel:
    matrix:
      - test_set:
        - inputvalidation/
        - up-to-renaming-ttimp-eq/
        - canonicsig/
        - cons-analysis/
        - derivation/infra/
        - arg-deps/
        - derivation/least-effort/print
        - derivation/least-effort/run
        - derivation/core/
  script:
    - make test-deptycheck only=gen-derivation/"$test_set" INTERACTIVE="--color" threads=2

pil:build:
  extends:
    - .uses-prepared-pack
    - .idris-build-job
  stage: pil:build
  needs:
    - prepare-pack
    - deptycheck:build
  script:
    - make pil

pil:test:
  extends: .uses-prepared-pack
  stage: pil:test
  needs:
    - prepare-pack
    - pil:build
    - deptycheck:test:lib
  script:
    - make test-pil INTERACTIVE="--color"

include:
  - remote: 'https://jobs.r2devops.io/latest/super_linter.yml'

super_linter:
  stage: lint
  needs: []
  image:
    name: ${CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX}/github/super-linter:slim-v4
  variables:
    FILTER_REGEX_EXCLUDE: ".*/thirdparty/.*"
    VALIDATE_JSCPD_ALL_CODEBASE: "true"

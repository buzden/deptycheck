#!/bin/sh

convert_idr_file() {
  sed -En \
    -e 's/(%default total)/\1\n\n%language ElabReflection/' \
    -e '/checkedGen :/!H;/checkedGen :/{s/checkedGen : (.*)$/%runElab deriveGenPrinter @{MainCoreDerivator @{LeastEffort}} $\n  \1/;H;x;p}' \
    "$1" > "$2"
}

FROM="$1"
TO="$2"

if [ -z "$FROM" ]; then
  echo "No source directory" >&2
  exit 1
fi
if [ -z "$TO" ]; then
  echo "No destination directory" >&2
  exit 2
fi

if [ ! -d "$FROM" ]; then
  echo "Bad source directory" >&2
  exit 3
fi
if [ -e "$TO" ]; then
  if [ ! -d "$TO" ]; then
    echo "Destinaton already exists, but is not a directory" >&2
    exit 4
  fi
  echo "Destinaton already exists, rewriting..."
else
  echo "Creating destination directory..."
  mkdir -p "$TO"
fi

SYMLINKS="derive.ipkg run RunDerivedGen.idr"

if [ ! -f "$FROM/DerivedGen.idr" ]; then
  echo "No 'DerivedGen.idr' in the source directory" >&2
  exit 5
fi
for s in $SYMLINKS; do
  if [ ! -h "$FROM/$s" ]; then
    echo "No '$s' symlink in the source directory" >&2
    exit 6
  fi
done

echo "Converting the generator file..."
convert_idr_file "$FROM/DerivedGen.idr" "$TO/DerivedGen.idr"
for s in $SYMLINKS; do
  if [ ! -e "$TO/$s" ]; then
    echo "Copying symlink $s..."
    cp "$FROM/$s" "$TO/$s"
  fi
done
